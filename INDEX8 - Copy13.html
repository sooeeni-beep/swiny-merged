<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>Swiny — Drilling Live (Standalone)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- React & ReactDOM (UMD dev builds) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel (compile JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles (inline for simplicity) -->
    <style>
      *{box-sizing:border-box}
      html,body,#root{height:100%}
      body{margin:0;background:#f6f7fb;color:#111;font-family: IRANYekan, tahoma, sans-serif}
      table{border-collapse:collapse;width:100%}
      th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
      thead th{background:#f3f4f6;font-weight:600}
      .menu-section-title{font-size:12px;color:#667085;margin:10px 0 6px}
      .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
      .status-table{margin-top:12px}
      .badge{display:inline-block;background:#e5edff;border:1px solid #c7d2fe;color:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px}
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      // ===== Dummy UI primitives used by this file (to keep one-file) =====
      const Card = ({title, actions, children}) => (
        <div style={{background:'#fff',border:'1px solid #e5e7eb',borderRadius:14,padding:12,boxShadow:'0 1px 2px rgba(0,0,0,0.04)',marginBottom:12}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
            <div style={{fontWeight:600}}>{title}</div>
            {actions}
          </div>
          {children}
        </div>
      );
      const Badge = ({tone='blue', children}) => <span className="badge">{children}</span>;
      const ItemBtn = ({onClick, children}) => (
        <button onClick={onClick} style={{padding:'8px 10px',border:'1px solid #e5e7eb',background:'#fff',borderRadius:10,cursor:'pointer'}}>{children}</button>
      );
      const Select = ({label, value, onChange, options}) => (
        <label style={{display:'flex',flexDirection:'column',gap:6}}>
          <span style={{fontSize:12,color:'#667085'}}>{label}</span>
          <select style={{padding:'8px 10px',border:'1px solid #e5e7eb',borderRadius:10}}
                  value={value} onChange={e=>onChange(e.target.value)}>
            {options.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}
          </select>
        </label>
      );
      const TextInput = ({label, value, onChange, placeholder}) => (
        <label style={{display:'flex',flexDirection:'column',gap:6}}>
          <span style={{fontSize:12,color:'#667085'}}>{label}</span>
          <input style={{padding:'8px 10px',border:'1px solid #e5e7eb',borderRadius:10}}
                 value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} />
        </label>
      );

      const styles = {
        grid3: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))', gap: 12 },
        table: { width:'100%' },
        th: { fontWeight:600, background:'#f3f4f6' },
        td: { },
      };

      // ===== Helpers (stubs compatible with your app) =====
      const toFa = (v)=> new Intl.NumberFormat('fa-IR').format(Number(v||0));
      const nowISO = ()=> new Date().toISOString();
      const jalaliToISO = (j)=> j; // NOTE: replace with your existing Jalaali converter

      // Sample data readers (replace with your app's localStorage keys/structures)
      const readLS = (k, d)=>{ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch(e){ return d } };

      function App(){
        // ======= EXISTING STATES (placeholder / mock for demo) =======
        const [currentProjectId, setCurrentProjectId] = useState('DEMO');
        const currentProject = { id: 'DEMO', name: 'نمونه' };
        const [tab, setTab] = useState('sv_contractor');

        // Mock datasets (in app you already have these):
        const projContractors = useMemo(()=>[
          {id:'C1', company:'پیمانکار الف'},
          {id:'C2', company:'پیمانکار ب'},
        ],[]);

        // In your real app, use your existing projHoles/projRates/rateMap
        const projHoles = useMemo(()=> readLS('swiny_holes', [
          { id:1, rateId:'R1', contractorId:'C1', groupType:'contractor', dateInitial:'2025-10-01T00:00:00Z', depthChecked1:12 },
          { id:2, rateId:'R1', contractorId:'C1', groupType:'contractor', dateInitial:'2025-10-03T00:00:00Z' },
          { id:3, rateId:'R2', contractorId:'C2', groupType:'contractor', dateInitial:'2025-10-05T00:00:00Z', jDateChecked:'1404-07-15' },
        ]), []);
        const projRates = useMemo(()=> readLS('swiny_rates', [
          { id:'R1', name:'حفر چاهک ۱ تا ۵ متر', price: 1500000 },
          { id:'R2', name:'حفر چاهک ۵ تا ۱۰ متر', price: 2200000 },
        ]), []);
        const rateMap = useMemo(()=> Object.fromEntries(projRates.map(r=>[r.id, r])), [projRates]);

        // === SV (Contractor Statement) filters ===
        const [svContractorId, setSvContractorId] = useState("");
        const [svJStart, setSvJStart] = useState("");
        const [svJEnd, setSvJEnd] = useState("");
        const [svCheckedOnly, setSvCheckedOnly] = useState(false);
        const [svAllPoints, setSvAllPoints] = useState(false);

        // === SV rows computation based on filters ===
        const svRows = useMemo(() => {
          const startISO = svJStart ? jalaliToISO(svJStart) : "";
          const endISO = svJEnd ? jalaliToISO(svJEnd) : "";
          let filtered = projHoles.filter(h => true);
          if (svContractorId) filtered = filtered.filter(h => h.groupType === "contractor" && h.contractorId === svContractorId);
          if (startISO) filtered = filtered.filter(h => (h.dateInitial || "") >= startISO);
          if (endISO)   filtered = filtered.filter(h => (h.dateInitial || "") <= endISO);
          if (svCheckedOnly) filtered = filtered.filter(h => !!(h && (h.depthChecked1!=null || h.jDateChecked || h.dateChecked)));
          else if (svAllPoints) filtered = filtered.filter(h => !(h && (h.depthChecked1!=null || h.jDateChecked || h.dateChecked)));

          const map = {};
          filtered.forEach(h => {
            const rate = rateMap[h.rateId];
            const title = rate?.name || "—";
            map[title] = map[title] || { title, unit: "نقطه", count: 0, unitPrice: 0 };
            map[title].count += 1;
          });

          const today = nowISO();
          Object.values(map).forEach(g => {
            const sampleRate = projRates.find(r => r.name === g.title);
            g.unitPrice = Number(sampleRate?.price || sampleRate?.unitPrice || 0); // replace with resolvePriceAtDate if you use versions
          });

          const rows = Object.values(map).map(g => ({ ...g, total: g.count * (g.unitPrice || 0) }));
          rows.sort((a,b)=> a.title.localeCompare(b.title, 'fa'));
          return rows;
        }, [projHoles, projRates, rateMap, svContractorId, svJStart, svJEnd, svCheckedOnly, svAllPoints]);

        return (
          <div style={{maxWidth:1100, margin:'0 auto', padding:16}}>
            {/* === MENU (only showcases added items) === */}
            <Card title="منو">
              <div className="menu-section-title" style={{marginTop:10}}>صورت وضعیت</div>
              <div className="menu-grid">
                <ItemBtn onClick={()=>setTab('sv_contractor')}>صورت وضعیت پیمانکار</ItemBtn>
                <ItemBtn onClick={()=>setTab('sv_company')}>صورت وضعیت شرکت</ItemBtn>
              </div>
            </Card>

            {/* === TABS === */}
            {tab === 'sv_contractor' && (
              <Card title="صورت وضعیت پیمانکار" actions={<Badge>پروژه: {currentProject?.name || currentProjectId}</Badge>}>
                <div style={styles.grid3}>
                  <Select
                    label="پیمانکار"
                    value={svContractorId}
                    onChange={setSvContractorId}
                    options={[{value:"", label:"همه پیمانکاران"}, ...projContractors.map(c=>({value:c.id, label:(c.company || c.id)}))]}
                  />
                  <TextInput label="از تاریخ (جلالی)" value={svJStart} onChange={setSvJStart} placeholder="YYYY-MM-DD" />
                  <TextInput label="تا تاریخ (جلالی)" value={svJEnd} onChange={setSvJEnd} placeholder="YYYY-MM-DD" />
                </div>

                <div style={{display:'flex', gap:16, alignItems:'center', marginTop:10}}>
                  <label style={{display:'flex', alignItems:'center', gap:6}}>
                    <input type="checkbox" checked={svCheckedOnly} onChange={(e)=>{ setSvCheckedOnly(e.target.checked); if (e.target.checked) setSvAllPoints(false); }} />
                    نقاط چِک‌مِنی شده
                  </label>
                  <label style={{display:'flex', alignItems:'center', gap:6}}>
                    <input type="checkbox" checked={svAllPoints} onChange={(e)=>{ setSvAllPoints(e.target.checked); if (e.target.checked) setSvCheckedOnly(false); }} />
                    همه نقاط (فاقد چک‌من)
                  </label>
                </div>

                <div className="status-table">
                  <div style={{overflowX:'auto'}}>
                    <table style={{...styles.table, minWidth: 720}}>
                      <thead>
                        <tr>
                          <th style={styles.th}>ردیف</th>
                          <th style={styles.th}>شرح</th>
                          <th style={styles.th}>واحد</th>
                          <th style={styles.th}>تعداد چاله</th>
                          <th style={styles.th}>قیمت واحد</th>
                          <th style={styles.th}>مبلغ این دوره</th>
                        </tr>
                      </thead>
                      <tbody>
                        {svRows.length === 0 ? (
                          <tr>
                            <td colSpan="6" style={{textAlign:'center', padding:12, color:'#6B7280'}}>— موردی برای نمایش نیست —</td>
                          </tr>
                        ) : (
                          svRows.map((r, i) => (
                            <tr key={r.title}>
                              <td style={styles.td}>{toFa(i+1)}</td>
                              <td style={styles.td}>{r.title}</td>
                              <td style={styles.td}>نقطه</td>
                              <td style={styles.td}>{toFa(r.count)}</td>
                              <td style={styles.td}>{toFa(r.unitPrice)}</td>
                              <td style={styles.td}>{toFa(r.total)}</td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </Card>
            )}

            {tab === 'sv_company' && (
              <Card title="صورت وضعیت شرکت">
                <div style={{padding:12}}>در حال ساخت…</div>
              </Card>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
