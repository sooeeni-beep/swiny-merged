<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>صورت وضعیت پیمانکار</title>
  <style>
    :root{--bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6B7280; --th:#f3f4f6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#111;font-family:tahoma, sans-serif}
    /* تمام‌عرض */
    .wrap{width:100%;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title h1{font-size:18px;margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .field{display:flex;gap:6px;align-items:center}
    .field label{font-size:12px;color:#374151}
    select,input[type=text]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type=checkbox]{transform:scale(1.1)}
    .table-wrap{overflow-x:auto;margin-top:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--border);padding:8px;text-align:center;white-space:nowrap}
    thead th{background:var(--th);font-weight:600}
    .muted{color:var(--muted)}
    .dbg{margin-top:10px;font-size:12px;color:#374151;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px;display:none}
    .badge{color:#6b7280}
    .btn{padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>صورت وضعیت پیمانکار</h1>
        <div>
          <span id="projectBadge" class="badge"></span>
          <button id="toggleDbg" class="btn" style="margin-inline-start:8px">دیباگ</button>
        </div>
      </div>

      <!-- فیلترها در یک ردیف -->
      <div class="row">
        <div class="field">
          <label>پیمانکار</label>
          <select id="contractorSelect"><option value="">همه پیمانکاران</option></select>
        </div>
        <div class="field">
          <label id="startLabel">از تاریخ</label>
          <input id="startJ" type="text" placeholder="YYYY-MM-DD"/>
        </div>
        <div class="field">
          <label id="endLabel">تا تاریخ</label>
          <input id="endJ" type="text" placeholder="YYYY-MM-DD"/>
        </div>
        <div class="field">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="checkedOnly"/> نقاط چِک‌مِنی شده
          </label>
        </div>
        <div class="field">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="allPoints"/> همه نقاط (فاقد چک‌من)
          </label>
        </div>
      </div>

      <div class="table-wrap">
        <table style="min-width:900px">
          <thead>
            <tr>
              <th>ردیف</th>
              <th>شرح</th>
              <th>واحد</th>
              <th>تعداد چاله</th>
              <th>قیمت واحد</th>
              <th>مبلغ این دوره</th>
            </tr>
          </thead>
          <tbody id="svBody">
            <tr><td colspan="6" class="muted">— موردی برای نمایش نیست —</td></tr>
          </tbody>
        </table>
      </div>

      <div id="dbg" class="dbg"></div>
    </div>
  </div>

  <script>
    /* ---------- ابزار ---------- */
    const toFa = v => new Intl.NumberFormat('fa-IR').format(Number(v||0));
    const lsSafe = k => { try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : null }catch(e){ return null } };
    const todayISO = () => new Date().toISOString();

    /* تاریخ */
    function digitsOnly(s){ return String(s||'').replace(/[^0-9]/g,''); }
    function normalizeInputDate(s){ return digitsOnly(s); }
    function pickPrimaryDateField(holes){
      const fields = ['jDate','jDateInitial','dateInitial','date'];
      const score = {};
      (holes||[]).slice(0,100).forEach(h=>{
        fields.forEach(f=>{ if(h&&h[f]) score[f]=(score[f]||0)+1; });
      });
      let best = fields[0], mx=-1;
      for(const f of fields){ const v=score[f]||0; if(v>mx){mx=v; best=f;} }
      return best;
    }

    /* ---------- کشف خودکار کلیدها ---------- */
    function discoverData(){
      const keys = Object.keys(localStorage);

      // SETTINGS
      let settings = null, settingsKey = '';
      if (localStorage.getItem('swiny.settings.v1')) {
        settings = lsSafe('swiny.settings.v1'); settingsKey = 'swiny.settings.v1';
      }
      if (!settings) {
        for (const k of keys){
          const v = lsSafe(k);
          if (v && typeof v==='object' && !Array.isArray(v) && 'projectId' in v){ settings=v; settingsKey=k; break; }
        }
      }

      // HOLES
      let holes = null, holesKey = '';
      if (localStorage.getItem('swiny.drilling.holes.v5')){
        holes = lsSafe('swiny.drilling.holes.v5'); holesKey = 'swiny.drilling.holes.v5';
      }
      if (!holes){
        for (const k of keys){
          const v = lsSafe(k);
          if (Array.isArray(v) && v.length && typeof v[0]==='object'){
            const s = v[0];
            const likeHole = ('rateId' in s) && (('contractorId' in s) || ('contractor' in s)) && (('projectId' in s) || ('date' in s) || ('dateInitial' in s) || ('jDate' in s) || ('jDateInitial' in s));
            if (likeHole){ holes = v; holesKey = k; break; }
          }
        }
      }

      // RATES
      let rates = null, ratesKey = '';
      for (const k of keys){
        if (!/(^|[.\-_])(rate|price|fee|tariff|unit)([.\-_]|$)/i.test(k)) continue;
        const v = lsSafe(k);
        if (Array.isArray(v) && v.length && typeof v[0]==='object'){
          const s = v[0];
          const likeRate = ('name' in s || 'title' in s) && ('price' in s || 'unitPrice' in s || 'versions' in s);
          if (likeRate){ rates = v; ratesKey = k; break; }
        }
      }

      // CONTRACTORS: کلیدهایی که contractor دارند (نه projects)
      let contractors = null, contractorsKey = '';
      for (const k of keys){
        if (!/contractor/i.test(k)) continue;
        if (/project/i.test(k)) continue;
        const v = lsSafe(k);
        if (Array.isArray(v) && v.length && typeof v[0]==='object'){
          const s = v[0];
          const likeC = ('id' in s || 'code' in s) && ('company' in s || 'name' in s || 'title' in s);
          if (likeC){ contractors = v; contractorsKey = k; break; }
        }
      }
      if (!contractors && Array.isArray(holes)){
        const set = new Map();
        holes.forEach(h=>{
          const id = h.contractorId || h.contractor || h.contractorCode;
          const label = h.contractorName || h.contractorTitle || id;
          if (id) set.set(id, {id, company: label||id});
        });
        contractors = Array.from(set.values());
        contractorsKey = '(derived from holes)';
      }

      return {settings, settingsKey, holes, holesKey, rates, ratesKey, contractors, contractorsKey};
    }

    function filterByProject(arr, pid){
      if (!pid || !Array.isArray(arr)) return Array.isArray(arr) ? arr : [];
      return arr.filter(x => x && x.projectId === pid);
    }

    function mostRecentPriceFromRateObject(rateObj, todayIso){
      if (!rateObj) return 0;
      if (typeof rateObj === 'number') return rateObj;
      if (rateObj.price || rateObj.unitPrice) return Number(rateObj.price || rateObj.unitPrice || 0);
      const vers = rateObj.versions;
      if (Array.isArray(vers) && vers.length){
        const t = new Date(todayIso);
        const valid = vers.filter(v => !v.effective || new Date(String(v.effective).replace(/\//g,'-')) <= t);
        const pick = valid.length ? valid[valid.length-1] : vers[vers.length-1];
        return Number(pick?.price || pick?.unitPrice || 0);
      }
      return 0;
    }

    function unitPriceFor(rateRecOrArray, title, todayIso){
      if (!rateRecOrArray) return 0;
      if (Array.isArray(rateRecOrArray)){
        const cand = rateRecOrArray.filter(r => r && (r.name===title || r.title===title));
        if (!cand.length) return 0;
        cand.sort((a,b)=> new Date(String(a.effective||a.date||0).replace(/\//g,'-')) - new Date(String(b.effective||b.date||0).replace(/\//g,'-')));
        return mostRecentPriceFromRateObject(cand[cand.length-1], todayIso);
      }
      return mostRecentPriceFromRateObject(rateRecOrArray, todayIso);
    }

    /* ---------- بارگذاری ---------- */
    const D = discoverData();

    const currentProjectId = D.settings?.projectId || "";
    document.getElementById('projectBadge').textContent = currentProjectId ? ("پروژه: "+currentProjectId) : "";

    const holesAll = filterByProject(D.holes, currentProjectId);
    const ratesAll = filterByProject(D.rates, currentProjectId);
    const rateById = Object.fromEntries((ratesAll||[]).map(r=>[r.id, r]));
    const contractorsAll = filterByProject(D.contractors, currentProjectId) || D.contractors || [];

    const dateField = pickPrimaryDateField(holesAll);
    if (dateField && /^j/.test(dateField)){
      document.getElementById('startLabel').textContent = 'از تاریخ (جلالی)';
      document.getElementById('endLabel').textContent = 'تا تاریخ (جلالی)';
    } else {
      document.getElementById('startLabel').textContent = 'از تاریخ (میلادی)';
      document.getElementById('endLabel').textContent = 'تا تاریخ (میلادی)';
    }

    // سِلکت پیمانکار از تب پیمانکار
    const contractorSelect = document.getElementById('contractorSelect');
    (contractorsAll||[])
      .map(c=>({ id: c.id || c.code || c.company || '', title: c.company || c.name || c.title || (c.id||c.code||'') }))
      .filter(c=>c.id)
      .sort((a,b)=> a.title.localeCompare(b.title,'fa'))
      .forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.title; contractorSelect.appendChild(opt); });

    // دیباگ
    const dbgEl = document.getElementById('dbg');
    const toggleDbg = document.getElementById('toggleDbg');
    toggleDbg.addEventListener('click', ()=>{
      const on = dbgEl.style.display!=='block';
      dbgEl.style.display = on ? 'block' : 'none';
      if (on){
        dbgEl.innerHTML =
          `<div><b>settings</b> ← <code>${escapeHtml(D.settingsKey||'-')}</code> (projectId: ${escapeHtml(currentProjectId||'-')})</div>`+
          `<div><b>holes</b> ← <code>${escapeHtml(D.holesKey||'-')}</code> (rows: ${holesAll?.length||0}, dateField: ${dateField||'-'})</div>`+
          `<div><b>rates</b> ← <code>${escapeHtml(D.ratesKey||'-')}</code> (rows: ${ratesAll?.length||0})</div>`+
          `<div><b>contractors</b> ← <code>${escapeHtml(D.contractorsKey||'-')}</code> (rows: ${(contractorsAll||[]).length})</div>`;
      }
    });
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // ایونت‌ها
    const startEl = document.getElementById('startJ');
    const endEl = document.getElementById('endJ');
    const checkedEl = document.getElementById('checkedOnly');
    const allEl = document.getElementById('allPoints');
    checkedEl.addEventListener('change', ()=>{ if(checkedEl.checked) allEl.checked=false; render(); });
    allEl.addEventListener('change', ()=>{ if(allEl.checked) checkedEl.checked=false; render(); });
    startEl.addEventListener('input', render);
    endEl.addEventListener('input', render);
    contractorSelect.addEventListener('change', render);

    function isCheckedHole(h){
      return !!(h && (h.depthChecked1!=null || h.jDateChecked || h.dateChecked || h.checked===true));
    }

    function render(){
      const tbody=document.getElementById('svBody');
      tbody.innerHTML='';

      const cId = contractorSelect.value;
      const startIn = normalizeInputDate(startEl.value);
      const endIn   = normalizeInputDate(endEl.value);
      const todayIso = todayISO();

      let filtered = Array.isArray(holesAll) ? holesAll.slice() : [];
      if (cId) filtered = filtered.filter(h =>
        (h.groupType==='contractor' || !h.groupType) &&
        (h.contractorId===cId || h.contractor===cId || h.contractorCode===cId)
      );

      if (dateField){
        if (startIn) filtered = filtered.filter(h => {
          const d = digitsOnly(h[dateField]);
          return d && d >= startIn;
        });
        if (endIn) filtered = filtered.filter(h => {
          const d = digitsOnly(h[dateField]);
          return d && d <= endIn;
        });
      }

      if (checkedEl.checked) filtered = filtered.filter(isCheckedHole);
      else if (allEl.checked) filtered = filtered.filter(h => !isCheckedHole(h));

      // گروه‌بندی بر اساس rateId (نمایش شرح = نام آیتم نرخ)
      const groups = {}; // rateId -> {title, count}
      filtered.forEach(h=>{
        const rId = h.rateId || '__no_rate__';
        const rateRec = rateById[rId];
        const title = rateRec?.name || rateRec?.title || h.rateItemTitle || h.itemTitle || h.item || '—';
        if (!groups[rId]) groups[rId] = { title, count:0, rateRec };
        groups[rId].count += 1;
      });

      const rows = Object.values(groups);
      if (!rows.length){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=6; td.className='muted'; td.textContent='— موردی برای نمایش نیست —';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }

      rows.sort((a,b)=> (a.title||'').localeCompare(b.title||'', 'fa'));

      rows.forEach((g,i)=>{
        const unitPrice = unitPriceFor(g.rateRec || ratesAll, g.title, todayIso);
        const total = unitPrice * g.count;

        const tr=document.createElement('tr');
        function cell(v){ const td=document.createElement('td'); td.textContent=v; return td }
        tr.appendChild(cell(toFa(i+1)));
        tr.appendChild(cell(g.title||'—'));
        tr.appendChild(cell('نقطه'));
        tr.appendChild(cell(toFa(g.count)));
        tr.appendChild(cell(toFa(unitPrice)));
        tr.appendChild(cell(toFa(total)));
        tbody.appendChild(tr);
      });
    }

    render();
  </script>
</body>
</html>
