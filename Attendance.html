<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حضور و غیاب</title>
  <style>
    :root{--bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6B7280; --th:#f3f4f6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#111;font-family:tahoma, sans-serif}
    .wrap{width:100%;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title h1{font-size:18px;margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .field{display:flex;gap:6px;align-items:center}
    .field label{font-size:12px;color:#374151}
    select,input{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .muted{color:#6B7280}
    .hint{font-size:12px;color:#6b7280;margin:6px 0}
    .table-wrap{overflow-x:auto;margin-top:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;white-space:nowrap}
    thead th{background:var(--th);font-weight:600;position:sticky;top:0}
    .cell-day{min-width:34px;font-weight:600;letter-spacing:0.2px;user-select:none}
    .cell-day.editable{cursor:pointer}
    .cell-disabled{background:#f1f1f1;color:#9ca3af}
    /* رنگ‌بندی وضعیت‌ها */
    .st-P{background:#dcfce7}  /* سبز */
    .st-R{background:#fef9c3}  /* زرد */
    .st-AS{background:#f3e8ff} /* بنفش */
    .st-A{background:#fee2e2}  /* قرمز */
    .legend{font-size:12px;color:#374151;display:flex;gap:10px;align-items:center}
    .badge{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>حضور و غیاب</h1>
        <div class="legend">
          <span class="badge" id="projectBadge"></span>
          <span>کلیدها: <b>P</b>=حضور، <b>R</b>=مرخصی، <b>AS</b>=استعلاجی، <b>A</b>=غایب</span>
        </div>
      </div>

      <!-- کنترل‌ها -->
      <div class="row">
        <div class="field">
          <label>جستجو بر اساس</label>
          <select id="searchBy">
            <option value="fullName">نام و نام خانوادگی</option>
            <option value="code">کد پرسنلی</option>
            <option value="position">سمت</option>
          </select>
        </div>
        <div class="field">
          <label>جستجو</label>
          <input id="searchInput" type="text" placeholder="عبارت جستجو"/>
        </div>
        <div class="field">
          <label>ماه (شمسی)</label>
          <select id="monthSel"></select>
        </div>
        <div class="field">
          <label>سال (شمسی)</label>
          <select id="yearSel"></select>
        </div>
        <div class="field">
          <label>بازه کاری از روز</label>
          <select id="rangeStart"></select>
        </div>
        <div class="field">
          <label>تا روز</label>
          <select id="rangeEnd"></select>
        </div>
        <button class="btn" id="refreshBtn">بازخوانی</button>
        <button class="btn" id="exportBtn">خروجی CSV</button>
      </div>

      <div class="hint" id="usersHint"></div>

      <div class="table-wrap">
        <table id="attTable">
          <thead id="thead"></thead>
          <tbody id="tbody">
            <tr><td class="muted" style="text-align:center;padding:12px">— موردی برای نمایش نیست —</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ==== ابزار عمومی ==== */
    const lsGet = (k,d=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };
    const lsSet = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const toFa = v => new Intl.NumberFormat('fa-IR').format(Number(v||0));
    const JMONTHS = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];

    /* ==== تقویم جلالی (طول ماه و کبیسه) ==== */
    function isJLeap(jy){
      const breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];
      let bl=breaks.length,jp=breaks[0],jm,jump=0,leap=0,n=0,i=1;
      if (jy<jp || jy>=breaks[bl-1]) return false;
      for(; i<bl; i++){ jm=breaks[i]; jump=jm-jp; if(jy<jm) break; jp=jm; }
      n=jy-jp; if (jump-n<6) n=n-jump+Math.floor((jump+4)/33)*33;
      leap=Math.floor(((n+1)%33)-1); if (leap===-1) leap=32;
      return (leap===0||leap===4||leap===8||leap===12||leap===16||leap===20||leap===24||leap===28);
    }
    function jMonthLen(jy,jm){ if(jm<=6) return 31; if(jm<=11) return 30; return isJLeap(jy)?30:29; }

    /* ==== کشف settings و users (حالت فارسی هم) ==== */
    function discover(){
      const keys = Object.keys(localStorage);
      // settings
      let settings=null, settingsKey='';
      if (localStorage.getItem('swiny.settings.v1')){ settings=lsGet('swiny.settings.v1'); settingsKey='swiny.settings.v1'; }
      if(!settings){
        for (const k of keys){
          const v=lsGet(k);
          if (v && typeof v==='object' && !Array.isArray(v) && 'projectId' in v){ settings=v; settingsKey=k; break; }
        }
      }
      // users: الگوهای معروف
      let users=null, usersKey='';
      const rx=/(^|[.\-_])(user|users|staff|personnel|employee|member|members|operator|operators|account|accounts|people|person|crew|team)([.\-_]|$)/i;
      for (const k of keys){
        if (!rx.test(k)) continue;
        const v=lsGet(k);
        if (Array.isArray(v) && v.length && typeof v[0]==='object'){ users=v; usersKey=k; break; }
      }
      // اگر هنوز پیدا نشد، جستجوی هوشمند روی همه‌ی کلیدها (به‌خصوص فارسی)
      if (!users){
        for (const k of keys){
          const v=lsGet(k);
          if (!Array.isArray(v) || !v.length || typeof v[0] !== 'object') continue;
          const s=v[0];
          const hasName = ('fullName' in s) || ('name' in s) || ('نام' in s) || ('نام و نام خانوادگی' in s) || ('نام‌ونام‌خانوادگی' in s);
          const hasCode = ('code' in s) || ('id' in s) || ('personnelCode' in s) || ('empCode' in s) || ('شماره پرسنلی' in s) || ('کد پرسنلی' in s);
          const hasRole = ('position' in s) || ('role' in s) || ('title' in s) || ('سمت' in s) || ('پست سازمانی' in s) || ('نقش' in s);
          if ((hasName && hasCode) || (hasCode && hasRole) || (hasName && hasRole)){ users=v; usersKey=k; break; }
        }
      }
      return {settings, settingsKey, users, usersKey};
    }

    function synthCode(u, idx){
      const base = (u.fullName||u.name||'user').toString().trim().replace(/\s+/g,'_').slice(0,24) || 'user';
      return `code:${base}_${idx+1}`;
    }

    // نرمال‌سازی: پشتیبانی از فارسی
    function normalizeUser(u, idx){
      const fa = {
        first: u['نام'] || u['نام کوچک'],
        last:  u['نام خانوادگی'] || u['فامیلی'],
        full:  u['نام و نام خانوادگی'] || u['نام‌ونام‌خانوادگی'],
        code:  u['شماره پرسنلی'] || u['کد پرسنلی'] || u['کدپرسنلی'] || u['کد_پرسنلی'],
        pos:   u['سمت'] || u['پست سازمانی'] || u['نقش'],
        pid:   u['پروژه'] || u['کد پروژه']
      };
      const code = u.code || u.id || u.personnelCode || u.empCode || u.username || fa.code || '';
      const first = u.firstName || u.fname || u.name || fa.first || '';
      const last  = u.lastName || u.lname || u.family || u.surname || fa.last || (u.name && u.name.split(' ').slice(1).join(' ')) || '';
      const full  = u.fullName ? u.fullName : (fa.full ? fa.full : ((first||last)? [first,last].filter(Boolean).join(' ') : (u.name||'')));
      const pos   = u.position || u.role || u.title || u.jobTitle || fa.pos || '';
      const pid   = u.projectId || fa.pid || '';
      const finalCode = (code && String(code).trim()) ? String(code) : synthCode({fullName:full,name:u.name}, idx);
      return { code: finalCode, rawCode: code||'', fullName: (full||'').trim(), position: (pos||'').trim(), projectId: (pid||'').toString().trim() };
    }

    /* ==== استوریج حضور/غیاب ماتریسی ==== */
    const K_ATT = 'swiny.attendance.matrix.v1';
    function loadMatrix(){ const a=lsGet(K_ATT, []); return Array.isArray(a)? a : []; }
    function saveMatrix(arr){ lsSet(K_ATT, arr); }
    function findRow(arr, projectId, code, jYear, jMonth){
      return arr.find(x=> (x.projectId||'')=== (projectId||'') && x.code===code && x.jYear===jYear && x.jMonth===jMonth);
    }
    function getOrCreateRow(arr, projectId, code, jYear, jMonth, daysCount){
      let r = findRow(arr, projectId, code, jYear, jMonth);
      if (!r){ r = { projectId: projectId||'', code, jYear, jMonth, days:{} }; arr.push(r); }
      for(let d=1; d<=daysCount; d++){ const k=String(d); if(!(k in r.days)) r.days[k]=''; }
      return r;
    }

    /* ==== حالت صفحه ==== */
    const D = discover();
    const currentProjectId = D.settings?.projectId || '';
    if (currentProjectId) document.getElementById('projectBadge').textContent = 'پروژه: '+currentProjectId;

    const allUsersRaw = Array.isArray(D.users) ? D.users : [];
    const allUsers = allUsersRaw.map((u,idx)=> normalizeUser(u, idx));
    // فیلتر پروژه؛ اگر خالی شد، فیلتر پروژه نادیده گرفته شود تا نمایش داشته باشیم
    let users = currentProjectId ? allUsers.filter(u => !u.projectId || u.projectId===currentProjectId) : allUsers;
    if (!users.length) users = allUsers.slice();

    // سال/ماه شمسی
    const yearSel = document.getElementById('yearSel');
    for(let y=1398; y<=1410; y++){ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSel.appendChild(opt); }
    yearSel.value = 1404;
    const monthSel = document.getElementById('monthSel');
    JMONTHS.forEach((nm,i)=>{ const opt=document.createElement('option'); opt.value=i+1; opt.textContent=nm; monthSel.appendChild(opt); });
    monthSel.value = 7; // مهر

    // بازه کاری
    const rangeStart = document.getElementById('rangeStart');
    const rangeEnd = document.getElementById('rangeEnd');
    for(let d=1; d<=31; d++){
      let o1=document.createElement('option'); o1.value=d; o1.textContent=d; rangeStart.appendChild(o1);
      let o2=document.createElement('option'); o2.value=d; o2.textContent=d; rangeEnd.appendChild(o2);
    }
    rangeStart.value = 21; rangeEnd.value = 20;

    const searchByEl = document.getElementById('searchBy');
    const searchInputEl = document.getElementById('searchInput');

    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const usersHint = document.getElementById('usersHint');
    function showUsersHint(){
      usersHint.textContent = `کلید کاربران: ${D.users ? D.usersKey : '— یافت نشد —'} | کل: ${allUsers.length} | پس از فیلتر: ${users.length}`;
    }

    function makeHeader(jYear, jMonth, daysCount, startDay, endDay){
      thead.innerHTML='';
      const tr=document.createElement('tr');
      ['ردیف','کد پرسنلی','نام و نام خانوادگی','سمت'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; tr.appendChild(th); });
      for(let d=1; d<=daysCount; d++){
        const th=document.createElement('th'); th.textContent=d;
        if (!dayInWindow(d, daysCount, startDay, endDay)) th.classList.add('cell-disabled');
        tr.appendChild(th);
      }
      const thAct=document.createElement('th'); thAct.textContent='اقدام'; tr.appendChild(thAct);
      thead.appendChild(tr);
    }
    function dayInWindow(d, daysCount, startDay, endDay){
      if (endDay >= startDay) return d>=startDay && d<=endDay;
      return (d>=startDay && d<=daysCount) || (d>=1 && d<=endDay);
    }
    function applySearch(list){
      const by = searchByEl.value; 
      const q = (searchInputEl.value||'').trim().toLowerCase();
      if (!q) return list;
      return list.filter(u=> (u[by]||'').toString().toLowerCase().includes(q));
    }
    function cycle(val){
      // '' -> P -> R -> AS -> A -> ''
      if (!val) return 'P';
      if (val==='P') return 'R';
      if (val==='R') return 'AS';
      if (val==='AS') return 'A';
      return '';
    }
    function applyStatusClass(td, val){
      td.classList.remove('st-P','st-R','st-AS','st-A');
      if (val==='P') td.classList.add('st-P');
      else if (val==='R') td.classList.add('st-R');
      else if (val==='AS') td.classList.add('st-AS');
      else if (val==='A') td.classList.add('st-A');
    }
    const editing = new Set(); // codes

    function render(){
      const jYear = Number(yearSel.value);
      const jMonth = Number(monthSel.value);
      const daysCount = jMonthLen(jYear, jMonth);
      const startDay = Math.min(Math.max(1, Number(rangeStart.value)), 31);
      const endDay   = Math.min(Math.max(1, Number(rangeEnd.value)), 31);

      showUsersHint();
      makeHeader(jYear, jMonth, daysCount, startDay, endDay);
      tbody.innerHTML='';

      const list = applySearch(users.slice()).sort((a,b)=> (a.fullName||'').localeCompare(b.fullName||'', 'fa'));
      if (!list.length){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=4+daysCount+1; td.className='muted'; td.textContent='— موردی برای نمایش نیست —';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }

      const store = loadMatrix();

      list.forEach((u, idx)=>{
        const tr=document.createElement('tr');
        function cell(v){ const td=document.createElement('td'); td.textContent=v; return td }
        tr.appendChild(cell(toFa(idx+1)));
        tr.appendChild(cell(u.code||''));
        tr.appendChild(cell(u.fullName||''));
        tr.appendChild(cell(u.position||''));

        const row = getOrCreateRow(store, currentProjectId, u.code, jYear, jMonth, daysCount);

        for(let d=1; d<=daysCount; d++){
          const td=document.createElement('td');
          td.className='cell-day';
          td.dataset.day = String(d);
          td.dataset.code = u.code;
          const v = row.days[String(d)] || '';
          td.textContent = v;
          applyStatusClass(td, v);

          const enabled = dayInWindow(d, daysCount, startDay, endDay);
          if (!enabled) td.classList.add('cell-disabled');

          td.addEventListener('click', ()=>{
            if (!editing.has(u.code)) return;
            if (!enabled) return;
            const cur = row.days[String(d)] || '';
            const nxt = cycle(cur);
            row.days[String(d)] = nxt;
            td.textContent = nxt;
            applyStatusClass(td, nxt);
          });

          if (editing.has(u.code)) td.classList.add('editable'); else td.classList.remove('editable');
          tr.appendChild(td);
        }

        const tdAct=document.createElement('td');
        const btn=document.createElement('button'); btn.className='btn';
        const setEditingUi = ()=>{
          btn.textContent = editing.has(u.code) ? 'ذخیره' : 'اصلاح';
          [...tr.querySelectorAll('.cell-day')].forEach(td=>{
            if (editing.has(u.code)) td.classList.add('editable');
            else td.classList.remove('editable');
          });
        };
        btn.addEventListener('click', ()=>{
          if (editing.has(u.code)){
            saveMatrix(store);
            editing.delete(u.code);
            setEditingUi();
          }else{
            editing.add(u.code);
            setEditingUi();
          }
        });
        setEditingUi();
        tdAct.appendChild(btn); tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });
    }

    // CSV با درج دوره
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const jYear = Number(yearSel.value);
      const jMonth = Number(monthSel.value);
      const daysCount = jMonthLen(jYear, jMonth);
      const startDay = Math.min(Math.max(1, Number(rangeStart.value)), 31);
      const endDay   = Math.min(Math.max(1, Number(rangeEnd.value)), 31);

      const windowDays = [];
      if (endDay >= startDay){
        for(let d=startDay; d<=endDay; d++) windowDays.push({m:jMonth, d});
      } else {
        for(let d=startDay; d<=daysCount; d++) windowDays.push({m:jMonth, d});
        const nextMonth = jMonth===12 ? 1 : jMonth+1;
        const nextYear  = jMonth===12 ? (jYear+1) : jYear;
        const nextDaysCount = jMonthLen(nextYear, nextMonth);
        for(let d=1; d<=Math.min(endDay, nextDaysCount); d++) windowDays.push({m:nextMonth, d});
      }

      const store = loadMatrix();
      const rows = [];
      let toMonth = (endDay >= startDay) ? jMonth : (jMonth===12 ? 1 : jMonth+1);
      let toYear  = (endDay >= startDay) ? jYear  : (jMonth===12 ? jYear+1 : jYear);
      const periodTitle = `دوره: ${jYear}/${String(jMonth).padStart(2,'0')}/${String(startDay).padStart(2,'0')} تا ${toYear}/${String(toMonth).padStart(2,'0')}/${String(endDay).padStart(2,'0')}`;
      rows.push([periodTitle]);
      const head = ['کد','نام و نام خانوادگی','سمت', ...windowDays.map(x=> `${x.m}/${String(x.d).padStart(2,'0')}`)];
      rows.push(head);

      const list = users.slice().sort((a,b)=> (a.fullName||'').localeCompare(b.fullName||'', 'fa'));
      list.forEach(u=>{
        const rowNow  = findRow(store, currentProjectId, u.code, jYear, jMonth) || {days:{}};
        const nextM   = (jMonth===12 ? 1 : jMonth+1);
        const nextY   = (jMonth===12 ? jYear+1 : jYear);
        const rowNext = findRow(store, currentProjectId, u.code, nextY, nextM) || {days:{}};
        const vals = windowDays.map(x=> (x.m===jMonth ? rowNow.days[String(x.d)] : rowNext.days[String(x.d)]) || '');
        rows.push([u.code||'', u.fullName||'', u.position||'', ...vals]);
      });

      const csv = rows.map(r => r.map(v => `"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `attendance_${jYear}-${String(jMonth).padStart(2,'0')}_${String(startDay).padStart(2,'0')}_to_${String(endDay).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    // رویدادها
    document.getElementById('refreshBtn').addEventListener('click', render);
    document.getElementById('monthSel').addEventListener('change', render);
    document.getElementById('yearSel').addEventListener('change', render);
    document.getElementById('rangeStart').addEventListener('change', render);
    document.getElementById('rangeEnd').addEventListener('change', render);
    document.getElementById('searchBy').addEventListener('change', render);
    document.getElementById('searchInput').addEventListener('input', render);

    // پروژه در نوار عنوان
    (function(){ const s=lsGet('swiny.settings.v1'); if (s?.projectId) document.getElementById('projectBadge').textContent='پروژه: '+s.projectId; })();

    // اولین رندر
    render();
  </script>
</body>
</html>
