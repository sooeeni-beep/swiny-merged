<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حضور و غیاب</title>
  <style>
    :root{--bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6B7280; --th:#f3f4f6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#111;font-family:tahoma, sans-serif}
    .wrap{width:100%;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title h1{font-size:18px;margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .field{display:flex;gap:6px;align-items:center}
    .field label{font-size:12px;color:#374151}
    select,input{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .muted{color:#6B7280}
    .table-wrap{overflow-x:auto;margin-top:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;white-space:nowrap}
    thead th{background:var(--th);font-weight:600;position:sticky;top:0}
    .cell-day{min-width:34px; font-weight:600; letter-spacing:0.2px; user-select:none}
    .cell-day.editable{cursor:pointer}
    .legend{font-size:12px;color:#374151;display:flex;gap:10px;align-items:center}
    .badge{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>حضور و غیاب</h1>
        <div class="legend">
          <span class="badge" id="projectBadge"></span>
          <span>کلیدها: <b>P</b>=حضور، <b>R</b>=مرخصی، <b>AS</b>=استعلاجی</span>
        </div>
      </div>

      <!-- نوار کنترل‌ها (فقط همینی که گفتی) -->
      <div class="row">
        <div class="field">
          <label>جستجو بر اساس</label>
          <select id="searchBy">
            <option value="fullName">نام و نام خانوادگی</option>
            <option value="code">کد پرسنلی</option>
            <option value="position">سمت</option>
          </select>
        </div>
        <div class="field">
          <label>جستجو</label>
          <input id="searchInput" type="text" placeholder="عبارت جستجو"/>
        </div>
        <div class="field">
          <label>ماه</label>
          <select id="monthSel"></select>
        </div>
        <div class="field">
          <label>سال</label>
          <select id="yearSel"></select>
        </div>
        <button class="btn" id="refreshBtn">بازخوانی</button>
      </div>

      <div class="table-wrap">
        <table id="attTable">
          <thead id="thead"></thead>
          <tbody id="tbody">
            <tr><td class="muted" style="text-align:center;padding:12px">— موردی برای نمایش نیست —</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ========== ابزار عمومی ========== */
    const lsGet = (k,d=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d }catch(e){ return d } };
    const lsSet = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const toFa = v => new Intl.NumberFormat('fa-IR').format(Number(v||0));
    const escapeHtml = s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function daysInMonth(year, month){ // month: 1..12
      return new Date(year, month, 0).getDate();
    }
    function pad2(n){ return (n<10?'0':'')+n; }

    /* ========== کشف داده‌ها (settings + users) ========== */
    function discover(){
      const keys = Object.keys(localStorage);
      // settings
      let settings=null, settingsKey='';
      if (localStorage.getItem('swiny.settings.v1')){ settings=lsGet('swiny.settings.v1'); settingsKey='swiny.settings.v1'; }
      if(!settings){
        for (const k of keys){
          const v=lsGet(k);
          if (v && typeof v==='object' && !Array.isArray(v) && 'projectId' in v){ settings=v; settingsKey=k; break; }
        }
      }
      // users (users/staff/personnel/employee)
      let users=null, usersKey='';
      for (const k of keys){
        if (!/(^|[.\-_])(user|users|staff|personnel|employee)([.\-_]|$)/i.test(k)) continue;
        const v=lsGet(k);
        if (Array.isArray(v) && v.length && typeof v[0]==='object'){ users=v; usersKey=k; break; }
      }
      return {settings, settingsKey, users, usersKey};
    }
    function normalizeUser(u){
      const code = u.code || u.id || u.empCode || u.personnelCode || u.username || '';
      const first = u.firstName || u.fname || u.name || '';
      const last  = u.lastName || u.lname || u.family || u.surname || (u.name && u.name.split(' ').slice(1).join(' ')) || '';
      const full  = u.fullName ? u.fullName : ((first || last) ? [first,last].filter(Boolean).join(' ') : (u.name||''));
      const pos   = u.position || u.role || u.title || u.jobTitle || '';
      const pid   = u.projectId || '';
      return { code, fullName: full, position: pos, projectId: pid };
    }

    /* ========== استوریج حضور/غیاب ماتریسی ========== */
    const K_ATT = 'swiny.attendance.matrix.v1';
    function loadMatrix(){ const a=lsGet(K_ATT, []); return Array.isArray(a)? a : []; }
    function saveMatrix(arr){ lsSet(K_ATT, arr); }
    function findRow(arr, projectId, code, year, month){
      return arr.find(x=> (x.projectId||'')=== (projectId||'') && x.code===code && x.year===year && x.month===month);
    }
    function getOrCreateRow(arr, projectId, code, year, month, daysCount){
      let r = findRow(arr, projectId, code, year, month);
      if (!r){ r = { projectId: projectId||'', code, year, month, days:{} }; arr.push(r); }
      // تضمین کلیدهای روز
      for(let d=1; d<=daysCount; d++){ const k=String(d); if(!(k in r.days)) r.days[k]=''; }
      return r;
    }

    /* ========== حالت صفحه ========== */
    const D = discover();
    const currentProjectId = D.settings?.projectId || '';
    if (currentProjectId) document.getElementById('projectBadge').textContent = 'پروژه: '+currentProjectId;

    const allUsers = Array.isArray(D.users) ? D.users.map(normalizeUser) : [];
    const users = currentProjectId ? allUsers.filter(u => !u.projectId || u.projectId===currentProjectId) : allUsers;

    // ماه/سال پیش‌فرض = امروز
    const now = new Date();
    const yearSel = document.getElementById('yearSel');
    const monthSel = document.getElementById('monthSel');
    for(let y=now.getFullYear()-1; y<=now.getFullYear()+1; y++){
      const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSel.appendChild(opt);
    }
    yearSel.value = now.getFullYear();
    for(let m=1; m<=12; m++){
      const opt=document.createElement('option'); opt.value=m; opt.textContent=m; monthSel.appendChild(opt);
    }
    monthSel.value = (now.getMonth()+1);

    const searchByEl = document.getElementById('searchBy');
    const searchInputEl = document.getElementById('searchInput');
    document.getElementById('refreshBtn').addEventListener('click', render);

    // ویرایش ردیف‌ها
    const editing = new Set(); // شامل code های در حال ویرایش

    /* ========== رندر جدول ========== */
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');

    function buildHeader(daysCount){
      thead.innerHTML='';
      const tr=document.createElement('tr');
      ['ردیف','کد پرسنلی','نام و نام خانوادگی','سمت'].forEach(h=>{
        const th=document.createElement('th'); th.textContent=h; tr.appendChild(th);
      });
      for(let d=1; d<=daysCount; d++){
        const th=document.createElement('th'); th.textContent=d; tr.appendChild(th);
      }
      const thAct=document.createElement('th'); thAct.textContent='اقدام'; tr.appendChild(thAct);
      thead.appendChild(tr);
    }

    function applySearch(list){
      const by = searchByEl.value; 
      const q = (searchInputEl.value||'').trim();
      if (!q) return list;
      const qN = q.toLowerCase();
      return list.filter(u=>{
        const val = (u[by]||'').toString().toLowerCase();
        return val.includes(qN);
      });
    }

    function cycle(val){
      // '' -> P -> R -> AS -> ''
      if (!val) return 'P';
      if (val==='P') return 'R';
      if (val==='R') return 'AS';
      return '';
    }

    function render(){
      const year = Number(yearSel.value);
      const month = Number(monthSel.value);
      const daysCount = daysInMonth(year, month);

      buildHeader(daysCount);
      tbody.innerHTML='';

      const list = applySearch(users.slice())
        .sort((a,b)=> (a.fullName||'').localeCompare(b.fullName||'', 'fa'));

      if (!list.length){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=4+daysCount+1; td.className='muted'; td.textContent='— موردی برای نمایش نیست —';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }

      const store = loadMatrix();

      list.forEach((u, idx)=>{
        const tr=document.createElement('tr');
        function cell(v){ const td=document.createElement('td'); td.textContent=v; return td }

        tr.appendChild(cell(toFa(idx+1)));
        tr.appendChild(cell(u.code||''));
        tr.appendChild(cell(u.fullName||''));
        tr.appendChild(cell(u.position||''));

        const row = getOrCreateRow(store, currentProjectId, u.code, year, month, daysCount);

        for(let d=1; d<=daysCount; d++){
          const td=document.createElement('td');
          td.className='cell-day';
          td.dataset.day = String(d);
          td.dataset.code = u.code;
          const v = row.days[String(d)] || '';
          td.textContent = v;
          if (editing.has(u.code)) td.classList.add('editable');
          // رفتار کلیک برای چرخش مقدار در حالت ویرایش
          td.addEventListener('click', ()=>{
            if (!editing.has(u.code)) return;
            const cur = row.days[String(d)] || '';
            const nxt = cycle(cur);
            row.days[String(d)] = nxt;
            td.textContent = nxt;
          });
          tr.appendChild(td);
        }

        // اقدام
        const tdAct=document.createElement('td');
        const btn=document.createElement('button'); btn.className='btn';
        const setEditingUi = ()=>{
          btn.textContent = editing.has(u.code) ? 'ذخیره' : 'اصلاح';
          // toggle کلاس editable برای همه سلول‌های این ردیف
          [...tr.querySelectorAll('.cell-day')].forEach(td=>{
            if (editing.has(u.code)) td.classList.add('editable');
            else td.classList.remove('editable');
          });
        };
        btn.addEventListener('click', ()=>{
          if (editing.has(u.code)){
            // ذخیره
            saveMatrix(store);
            editing.delete(u.code);
            setEditingUi();
          }else{
            editing.add(u.code);
            setEditingUi();
          }
        });
        setEditingUi();
        tdAct.appendChild(btn);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });
    }

    // رویداد تغییر ماه/سال/جستجو
    monthSel.addEventListener('change', render);
    yearSel.addEventListener('change', render);
    searchByEl.addEventListener('change', render);
    searchInputEl.addEventListener('input', render);

    // اولین رندر
    render();
  </script>
</body>
</html>
