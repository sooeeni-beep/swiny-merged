<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>حضور و غیاب</title>
  <style>
    :root{--bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --muted:#6B7280; --th:#f3f4f6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#111;font-family:tahoma, sans-serif}
    .wrap{width:100%;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title h1{font-size:18px;margin:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .field{display:flex;gap:6px;align-items:center}
    .field label{font-size:12px;color:#374151}
    select,input{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .muted{color:#6B7280}
    .hint{font-size:12px;color:#6b7280;margin:6px 0}
    .table-wrap{overflow-x:auto;margin-top:8px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--border);padding:6px 8px;text-align:center;white-space:nowrap}
    thead th{background:var(--th);font-weight:600;position:sticky;top:0}
    .cell-day{min-width:34px;font-weight:600;letter-spacing:0.2px;user-select:none}
    .cell-day.editable{cursor:pointer}
    .cell-disabled{background:#f1f1f1;color:#9ca3af}
    /* رنگ‌بندی وضعیت‌ها */
    .st-P{background:#dcfce7}  /* سبز */
    .st-R{background:#fef9c3}  /* زرد */
    .st-A{background:#fee2e2}  /* قرمز */
    .st-AS{background:#f3e8ff} /* بنفش */
    .legend{font-size:12px;color:#374151;display:flex;gap:10px;align-items:center}
    .badge{color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <h1>حضور و غیاب</h1>
        <div class="legend">
          <span class="badge" id="projectBadge"></span>
          <span>کلیدها: <b>P</b>=حضور، <b>R</b>=مرخصی، <b>A</b>=غایب، <b>AS</b>=استعلاجی</span>
        </div>
      </div>

      <!-- کنترل‌ها -->
      <div class="row">
        <div class="field">
          <label>جستجو بر اساس</label>
          <select id="searchBy">
            <option value="fullName">نام و نام خانوادگی</option>
            <option value="code">کد پرسنلی</option>
            <option value="position">سمت</option>
          </select>
        </div>
        <div class="field">
          <label>جستجو</label>
          <input id="searchInput" type="text" placeholder="عبارت جستجو"/>
        </div>
        <div class="field">
          <label>ماه (شمسی)</label>
          <select id="monthSel"></select>
        </div>
        <div class="field">
          <label>سال (شمسی)</label>
          <select id="yearSel"></select>
        </div>
        <div class="field">
          <label>بازه کاری از روز</label>
          <select id="rangeStart"></select>
        </div>
        <div class="field">
          <label>تا روز</label>
          <select id="rangeEnd"></select>
        </div>
        <button class="btn" id="refreshBtn">بازخوانی</button>
        <button class="btn" id="exportBtn">خروجی CSV</button>
      </div>

      <div class="hint" id="usersHint"></div>

      <div class="table-wrap">
        <table id="attTable">
          <thead id="thead"></thead>
          <tbody id="tbody">
            <tr><td class="muted" style="text-align:center;padding:12px">— موردی برای نمایش نیست —</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ===== ثابت‌ها ===== */
    const USERS_KEY = 'swiny.drilling.users.v1';        // ← کلید قطعی کاربران
    const K_ATT     = 'swiny.attendance.matrix.v1';      // ← ماتریس حضور/غیاب

    /* ===== ابزار عمومی ===== */
    const lsGet=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}};
    const lsSet=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const toFa=v=>new Intl.NumberFormat('fa-IR').format(Number(v||0));
    const JMONTHS=['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];

    /* ===== تقویم جلالی ===== */
    function isJLeap(jy){
      const breaks=[-61,9,38,199,426,686,756,818,1111,1181,1210,1635,2060,2097,2192,2262,2324,2394,2456,3178];
      let bl=breaks.length,jp=breaks[0],jm,jump=0,leap=0,n=0,i=1;
      if (jy<jp || jy>=breaks[bl-1]) return false;
      for(;i<bl;i++){jm=breaks[i];jump=jm-jp;if(jy<jm)break;jp=jm}
      n=jy-jp;if(jump-n<6)n=n-jump+Math.floor((jump+4)/33)*33;
      leap=Math.floor(((n+1)%33)-1);if(leap===-1)leap=32;
      return (leap===0||leap===4||leap===8||leap===12||leap===16||leap===20||leap===24||leap===28);
    }
    const jMonthLen=(jy,jm)=> jm<=6?31: jm<=11?30: (isJLeap(jy)?30:29);

    /* ===== users & settings ===== */
    const settings = lsGet('swiny.settings.v1', null);
    const currentProjectId = settings?.projectId || '';
    const usersRaw = lsGet(USERS_KEY, []);   // ← فقط از این کلید
    // نگاشت فارسی/انگلیسی به فرم واحد
    function normalizeUser(u, idx){
      const fullFa  = u['نام و نام خانوادگی'] || u['نام‌ونام‌خانوادگی'];
      const firstFa = u['نام'];
      const lastFa  = u['نام خانوادگی'];
      const codeFa  = u['شماره پرسنلی'] || u['کد پرسنلی'] || u['کدپرسنلی'] || u['کد_پرسنلی'];
      const posFa   = u['سمت'] || u['پست سازمانی'] || u['نقش'];
      const pidFa   = u['پروژه'] || u['کد پروژه'];

      const code = u.personnelNo || u.personnelCode || u.empCode || u.employeeCode || codeFa || u.code || '';
      const full = (u.fullName || fullFa || ((firstFa||'') + (lastFa?(' '+lastFa):''))).trim();
      const pos  = (u.position || u.jobTitle || u.role || posFa || '').trim();
      const pid  = (u.projectId || pidFa || '').toString().trim();

      const finalCode = (code && String(code).trim()) ? String(code) : `code:${idx+1}`;
      return { code: finalCode, fullName: full, position: pos, projectId: pid };
    }
    const allUsers = Array.isArray(usersRaw) ? usersRaw.map((u,i)=>normalizeUser(u,i)) : [];
    let users = currentProjectId ? allUsers.filter(u=>!u.projectId || u.projectId===currentProjectId) : allUsers;
    if (!users.length) users = allUsers.slice();

    /* ===== ذخیره ماتریسی ===== */
    const loadMatrix=()=>{const a=lsGet(K_ATT,[]);return Array.isArray(a)?a:[]};
    const saveMatrix=a=>lsSet(K_ATT,a);
    const findRow=(a,pid,code,jy,jm)=>a.find(x=>(x.projectId||'')===(pid||'') && x.code===code && x.jYear===jy && x.jMonth===jm);
    function getOrCreateRow(a,pid,code,jy,jm,days){
      let r=findRow(a,pid,code,jy,jm);
      if(!r){r={projectId:pid||'',code,jYear:jy,jMonth:jm,days:{}};a.push(r)}
      for(let d=1; d<=days; d++){const k=String(d); if(!(k in r.days)) r.days[k]=''}
      return r;
    }

    /* ===== UI wiring ===== */
    if (currentProjectId) document.getElementById('projectBadge').textContent = 'پروژه: '+currentProjectId;

    const yearSel=document.getElementById('yearSel');
    for(let y=1398;y<=1410;y++){const o=document.createElement('option');o.value=y;o.textContent=y;yearSel.appendChild(o)}
    yearSel.value=1404;
    const monthSel=document.getElementById('monthSel');
    JMONTHS.forEach((n,i)=>{const o=document.createElement('option');o.value=i+1;o.textContent=n;monthSel.appendChild(o)});
    monthSel.value=7;

    const rangeStart=document.getElementById('rangeStart');
    const rangeEnd=document.getElementById('rangeEnd');
    for(let d=1; d<=31; d++){
      let o1=document.createElement('option');o1.value=d;o1.textContent=d;rangeStart.appendChild(o1);
      let o2=document.createElement('option');o2.value=d;o2.textContent=d;rangeEnd.appendChild(o2);
    }
    rangeStart.value=21; rangeEnd.value=20;

    const searchByEl=document.getElementById('searchBy');
    const searchInputEl=document.getElementById('searchInput');
    const thead=document.getElementById('thead');
    const tbody=document.getElementById('tbody');
    const usersHint=document.getElementById('usersHint');

    function showUsersHint(){
      usersHint.textContent = `کلید کاربران: ${USERS_KEY} | کل: ${allUsers.length} | پس از فیلتر: ${users.length}`;
    }
    function dayInWindow(d,days,start,end){
      if(end>=start) return d>=start && d<=end;
      return (d>=start && d<=days) || (d>=1 && d<=end);
    }
    function makeHeader(jy,jm,days,start,end){
      thead.innerHTML='';
      const tr=document.createElement('tr');
      ['ردیف','کد پرسنلی','نام و نام خانوادگی','سمت'].forEach(h=>{const th=document.createElement('th'); th.textContent=h; tr.appendChild(th)});
      for(let d=1; d<=days; d++){
        const th=document.createElement('th'); th.textContent=d;
        if(!dayInWindow(d,days,start,end)) th.classList.add('cell-disabled');
        tr.appendChild(th);
      }
      const thAct=document.createElement('th'); thAct.textContent='اقدام'; tr.appendChild(thAct);
      thead.appendChild(tr);
    }
    function applySearch(list){
      const by=searchByEl.value, q=(searchInputEl.value||'').trim().toLowerCase();
      if(!q) return list; return list.filter(u=>(u[by]||'').toString().toLowerCase().includes(q));
    }
    // چرخه: '' -> P -> R -> A -> AS -> ''
    function cycle(v){ if(!v) return 'P'; if(v==='P') return 'R'; if(v==='R') return 'A'; if(v==='A') return 'AS'; return '' }
    function applyStatusClass(td,v){
      td.classList.remove('st-P','st-R','st-A','st-AS');
      if(v==='P') td.classList.add('st-P'); else if(v==='R') td.classList.add('st-R');
      else if(v==='A') td.classList.add('st-A'); else if(v==='AS') td.classList.add('st-AS');
    }
    const editing=new Set();

    function render(){
      const jy=Number(yearSel.value), jm=Number(monthSel.value);
      const days=jMonthLen(jy,jm);
      const start=Math.min(Math.max(1,Number(rangeStart.value)),31);
      const end=Math.min(Math.max(1,Number(rangeEnd.value)),31);

      showUsersHint();
      makeHeader(jy,jm,days,start,end);
      tbody.innerHTML='';

      const list=applySearch(users.slice()).sort((a,b)=>(a.fullName||'').localeCompare(b.fullName||'','fa'));
      if(!list.length){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=4+days+1; td.className='muted'; td.textContent='— موردی برای نمایش نیست —';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }

      const store=loadMatrix();

      list.forEach((u,idx)=>{
        const tr=document.createElement('tr');
        const cell=v=>{const td=document.createElement('td'); td.textContent=v; return td};
        tr.appendChild(cell(toFa(idx+1)));
        tr.appendChild(cell(u.code||''));
        tr.appendChild(cell(u.fullName||''));  // فقط نام واقعی کاربر
        tr.appendChild(cell(u.position||''));

        const row=getOrCreateRow(store,currentProjectId,u.code,jy,jm,days);
        for(let d=1; d<=days; d++){
          const td=document.createElement('td'); td.className='cell-day'; td.dataset.day=String(d); td.dataset.code=u.code;
          const v=row.days[String(d)]||''; td.textContent=v; applyStatusClass(td,v);
          const enabled=dayInWindow(d,days,start,end); if(!enabled) td.classList.add('cell-disabled');
          td.addEventListener('click',()=>{
            if(!editing.has(u.code) || !enabled) return;
            const cur=row.days[String(d)]||''; const nxt=cycle(cur);
            row.days[String(d)]=nxt; td.textContent=nxt; applyStatusClass(td,nxt);
          });
          if(editing.has(u.code)) td.classList.add('editable'); tr.appendChild(td);
        }
        const tdAct=document.createElement('td'); const btn=document.createElement('button'); btn.className='btn';
        const setUi=()=>{
          btn.textContent=editing.has(u.code)?'ذخیره':'اصلاح';
          [...tr.querySelectorAll('.cell-day')].forEach(x=> editing.has(u.code)?x.classList.add('editable'):x.classList.remove('editable'));
        };
        btn.addEventListener('click',()=>{ if(editing.has(u.code)){ saveMatrix(store); editing.delete(u.code);} else editing.add(u.code); setUi(); });
        setUi(); tdAct.appendChild(btn); tr.appendChild(tdAct); tbody.appendChild(tr);
      });
    }

    // خروجی CSV با BOM و درج عنوان دوره
    document.getElementById('exportBtn').addEventListener('click',()=>{
      const jy=Number(yearSel.value), jm=Number(monthSel.value);
      const days=jMonthLen(jy,jm);
      const start=Math.min(Math.max(1,Number(rangeStart.value)),31);
      const end=Math.min(Math.max(1,Number(rangeEnd.value)),31);

      const windowDays=[];
      if(end>=start){ for(let d=start; d<=end; d++) windowDays.push({m:jm,d}) }
      else{
        for(let d=start; d<=days; d++) windowDays.push({m:jm,d});
        const nm=jm===12?1:jm+1, ny=jm===12?jy+1:jy, nDays=jMonthLen(ny,nm);
        for(let d=1; d<=Math.min(end,nDays); d++) windowDays.push({m:nm,d});
      }

      const store=loadMatrix(), rows=[];
      const toMonth=(end>=start)?jm:(jm===12?1:jm+1);
      const toYear =(end>=start)?jy:(jm===12?jy+1:jy);
      rows.push([`دوره: ${jy}/${String(jm).padStart(2,'0')}/${String(start).padStart(2,'0')} تا ${toYear}/${String(toMonth).padStart(2,'0')}/${String(end).padStart(2,'0')}`]);
      rows.push(['کد','نام و نام خانوادگی','سمت',...windowDays.map(x=>`${x.m}/${String(x.d).padStart(2,'0')}`)]);

      const list=users.slice().sort((a,b)=>(a.fullName||'').localeCompare(b.fullName||'','fa'));
      list.forEach(u=>{
        const rowNow=findRow(store,currentProjectId,u.code,jy,jm)||{days:{}};
        const nm=jm===12?1:jm+1, ny=jm===12?jy+1:jy;
        const rowNext=findRow(store,currentProjectId,u.code,ny,nm)||{days:{}};
        const vals=windowDays.map(x=> (x.m===jm?rowNow.days[String(x.d)]:rowNext.days[String(x.d)]) || '');
        rows.push([u.code||'',u.fullName||'',u.position||'',...vals]);
      });

      const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const bom='\uFEFF'; // برای اکسل فارسی
      const blob=new Blob([bom+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=`attendance_${jy}-${String(jm).padStart(2,'0')}_${String(start).padStart(2,'0')}_to_${String(end).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    ['refreshBtn','monthSel','yearSel','rangeStart','rangeEnd','searchBy','searchInput'].forEach(id=>{
      const el=document.getElementById(id); el.addEventListener(id==='searchInput'?'input':'change', render);
    });

    // عنوان پروژه
    (function(){ const s=lsGet('swiny.settings.v1'); if(s?.projectId) document.getElementById('projectBadge').textContent='پروژه: '+s.projectId; })();

    // نخستین رندر
    render();
  </script>
</body>
</html>
